name: ðŸ§¹ Cleanup Test Data Delete Last 20 Articles

on:
  workflow_dispatch:
    # Allows manual triggering from the 'Actions' tab in GitHub

jobs:
  cleanup_articles:
    runs-on: ubuntu-latest
    
    # CRITICAL: This permission is required to commit the modified DB file back
    permissions:
      contents: write 
      
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4
        
      - name: 2. Execute SQLite Deletion Command (FINAL FIX)
        run: |
          DB_FILE="news_articles.db" 
          
          if [ ! -f "$DB_FILE" ]; then
              echo "ERROR: Database file not found at $DB_FILE."
              exit 1
          fi

          echo "Attempting to delete the last 20 articles from $DB_FILE (Table: news)..."
          
          # The table name is 'news' and the timestamp column is 'scraped_at'.
          sqlite3 "$DB_FILE" "
              DELETE FROM news 
              WHERE id IN (
                  SELECT id 
                  FROM news 
                  ORDER BY scraped_at DESC 
                  LIMIT 20
              );
          "

          if [ $? -ne 0 ]; then
              echo "Error running SQLite command. Check the database file integrity."
              exit 1
          fi
          echo "âœ… Successfully executed SQLite deletion command."
          
      - name: 3. Commit and Push Modified DB File
        # Makes the change permanent in your repository
        run: |
          DB_PATH="news_articles.db"
          
          if git status --porcelain | grep "$DB_PATH"; then
            echo "Changes detected in $DB_PATH. Committing and pushing..."
            git config user.name "GitHub Actions Bot"
            git config user.email "actions@github.com"
            git add "$DB_PATH"
            # [skip ci] prevents this commit from triggering other workflows
            git commit -m "chore(data): Deleted last 20 articles for testing purposes [skip ci]"
            git push
            echo "âœ… Successfully updated the database in the repository."
          else
            echo "No change detected in $DB_PATH. Nothing to commit."
          fi
