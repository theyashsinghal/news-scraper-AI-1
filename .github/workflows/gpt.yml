name:  GPT faster Run News Scraper with logs

on:
  # schedule:
  #   - cron: '*/30 * * * *'
  workflow_dispatch:

concurrency:
  group: news-scraper
  cancel-in-progress: false

jobs:
  scrape_news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Cache HuggingFace Models
        uses: actions/cache@v3
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-huggingface-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-huggingface-

      # Install Chrome
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      # Install ChromeDriver (match by major version using Chrome for Testing LATEST_RELEASE_<MAJOR>)
      - name: Install matching ChromeDriver
        env:
          TMPDIR: /tmp
        run: |
          set -euo pipefail

          # Get installed Chrome full version and major version
          CHROME_FULL_VERSION=$(google-chrome --version | sed 's/[^0-9.]//g' || true)
          if [ -z "$CHROME_FULL_VERSION" ]; then
            echo "google-chrome not found in PATH; aborting."
            exit 1
          fi
          MAJOR_VERSION=$(echo "$CHROME_FULL_VERSION" | cut -d'.' -f1)
          echo "Detected Chrome: $CHROME_FULL_VERSION (major: $MAJOR_VERSION)"

          # Resolve latest ChromeDriver build for this major version
          DRIVER_VERSION=$(wget -qO- "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${MAJOR_VERSION}" 2>/dev/null || true)
          if [ -z "$DRIVER_VERSION" ]; then
            echo "Failed to get LATEST_RELEASE_${MAJOR_VERSION}. Falling back to LATEST_RELEASE (latest overall)."
            DRIVER_VERSION=$(wget -qO- "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE" 2>/dev/null || true)
          fi
          if [ -z "$DRIVER_VERSION" ]; then
            echo "Could not determine ChromeDriver version. Aborting."
            exit 1
          fi
          echo "Resolved ChromeDriver version: $DRIVER_VERSION"

          DRIVER_URL="https://edgedl.me.gvt1.com/edgedl/chrome-for-testing/${DRIVER_VERSION}/linux64/chromedriver-linux64.zip"
          echo "Downloading ChromeDriver from: $DRIVER_URL"

          wget -q "$DRIVER_URL" -O /tmp/chromedriver.zip
          unzip -q /tmp/chromedriver.zip -d /tmp/chromedriver_extract

          sudo mv /tmp/chromedriver_extract/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver || \
            sudo mv /tmp/chromedriver_extract/chromedriver /usr/local/bin/chromedriver

          sudo chmod +x /usr/local/bin/chromedriver
          rm -rf /tmp/chromedriver.zip /tmp/chromedriver_extract

          echo "ChromeDriver installed at /usr/local/bin/chromedriver"

      # Start Xvfb for extra stability
      - name: Start Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 &

      # Install Python deps (CPU PyTorch first to avoid heavy GPU wheels)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install requests beautifulsoup4 trafilatura selenium sentence-transformers

      # Run scraper (ensure DISPLAY is set)
      - name: Run scraper
        env:
          DISPLAY: :99
          CHROMEDRIVER_PATH: /usr/local/bin/chromedriver
        run: |
          python news_scraper_AI_faster.py

      # Save logs with timestamp
      - name: Save logs with timestamp
        run: |
          mkdir -p logs
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          LOG_FILE="logs/scraper_${TIMESTAMP}_run${{ github.run_number }}.log"
          if [ -f news_scraper.log ]; then
            cp news_scraper.log "$LOG_FILE"
            echo "Log saved as $LOG_FILE"
          else
            echo "No log file found to save"
          fi

      # Commit and push DB + logs
      - name: Commit and push updated database and logs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git

          git add news_articles.db logs/ || true

          if ! git diff --staged --quiet; then
            echo "Changes detected, committing..."
            git commit -m "Update database and logs [skip ci]" || echo "Nothing to commit"

            echo "Pulling latest changes with rebase..."
            git pull --rebase origin main || {
              echo "Rebase conflict detected; preferring ours for db/logs"
              git checkout --ours news_articles.db logs/ || true
              git add news_articles.db logs/ || true
              git rebase --continue || echo "Manual rebase may be needed"
            }

            echo "Pushing changes..."
            MAX_RETRIES=3
            RETRY_COUNT=0
            until git push origin HEAD:main || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "Push failed, retry $RETRY_COUNT..."
              sleep 2
              git pull --rebase origin main || true
            done

            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "Failed to push after $MAX_RETRIES attempts"
              exit 1
            fi
            echo "Successfully pushed changes"
          else
            echo "No changes to commit"
          fi
